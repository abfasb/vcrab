<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V-CRAB SYSTEM - Reports</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS library for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        
        .main-content-transition {
            transition: margin-left 0.3s ease-in-out;
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sensor-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .logs-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .topbar {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #334155 100%);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
        }
        
        .nav-item {
            transition: all 0.2s ease-in-out;
        }
        
        .nav-item:hover {
            transform: translateX(4px);
            background: rgba(59, 130, 246, 0.1);
        }
        
        .nav-item.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .system-status {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: rgb(34, 197, 94);
        }
        
        .notification-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }
        
        .user-avatar {
            border: 2px solid rgba(59, 130, 246, 0.3);
            transition: all 0.2s ease-in-out;
        }
        
        .user-avatar:hover {
            border-color: rgba(59, 130, 246, 0.6);
            transform: scale(1.05);
        }
        
        .dropdown-menu {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }
        
        .mobile-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 1000;
            }
            
            .sidebar-open {
                transform: translateX(0);
            }
            
            .topbar {
                left: 0 !important;
            }
            
            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
            }
            
            .mobile-menu-button {
                display: flex;
            }
            
            .desktop-nav {
                display: none;
            }
        }
        
        @media (min-width: 1024px) {
            .mobile-menu-button {
                display: none;
            }
            
            .desktop-nav {
                display: flex;
            }
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .ping-animation {
            animation: ping 0.8s ease-in-out;
        }

        @keyframes ping {
            0% {
                transform: scale(1);
                background-color: #f87171;
            }
            50% {
                transform: scale(1.3);
                background-color: #ef4444;
            }
            100% {
                transform: scale(1);
                background-color: #f87171;
            }
        }

        .status-active {
            background: rgba(34, 197, 94, 0.1);
            color: rgb(34, 197, 94);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status-inactive {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .data-card {
            transition: all 0.3s ease;
        }
        
        .data-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .table-row:hover {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%);
        }
        
        .tab-button {
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .export-button {
            background: linear-gradient(135deg, #10b981, #3b82f6);
            transition: all 0.3s ease;
        }
        
        .export-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-optimal {
            background-color: #dcfce7;
            color: #166534;
        }
        
        .status-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .status-critical {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #fecaca;
        }

        .analytics-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .trend-up {
            color: #10b981;
        }

        .trend-down {
            color: #ef4444;
        }

        .trend-stable {
            color: #6b7280;
        }

        .export-dropdown {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        }

        .export-option {
            transition: all 0.2s ease;
        }

        .export-option:hover {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
            transform: translateX(4px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">

    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 left-0 w-72 h-screen z-50 transition-transform duration-300">
        <div class="p-6 border-b border-slate-600">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
                    <span class="text-xl">ðŸ¦€</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
                        V-CRAB
                    </h1>
                    <p class="text-xs text-slate-400">Aquaculture System</p>
                </div>
            </div>
        </div>

        <nav class="mt-8 px-4">
            <ul class="space-y-2">
                <li>
                    <a href="{{ url_for('dashboard') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-white rounded-lg font-medium">
                      <i class="fas fa-home w-4 h-4"></i>
                      <span>Dashboard</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('monitoring') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-desktop w-4 h-4"></i>
                      <span>Monitoring</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('controls') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-sliders-h w-4 h-4"></i>
                      <span>Controls</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('analytics') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-chart-line w-4 h-4"></i>
                      <span>Analytics</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('inventory') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-warehouse w-4 h-4"></i>
                      <span>Inventory</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('growth_monitoring') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-calendar-check w-4 h-4"></i>
                      <span>Crab Growth Monitoring</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('reports') }}" class="nav-item active flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-file-alt w-4 h-4"></i>
                      <span>Reports</span>
                    </a>
                  </li>
                  <li>
                    <a href="{{ url_for('notification') }}" class="nav-item flex items-center gap-3 px-4 py-3 text-slate-300 hover:text-white rounded-lg font-medium">
                      <i class="fas fa-bell w-4 h-4"></i>
                      <span>Notifications</span>
                      <span id="sidebarNotifBadge" class="ml-auto text-xs px-2 py-1 bg-red-500 rounded-full text-white hidden">0</span>
                    </a>
                  </li>
                </ul>
              </nav>
              
              <div class="absolute bottom-8 left-4 right-4">
                <button class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white px-4 py-3 rounded-lg font-semibold hover:shadow-lg hover:-translate-y-0.5 transition-all duration-200 flex items-center justify-center gap-2" onclick="logout()">
                  <i class="fas fa-sign-out-alt"></i>
                  <span>Sign Out</span>
                </button>
              </div>
            </div>

    <!-- Top Navigation -->
    <header class="topbar fixed top-0 right-0 h-16 z-40 flex items-center justify-between px-6 lg:left-72">
        <div class="flex items-center gap-4">
            <!-- Mobile Menu Button -->
            <button id="mobileMenuButton" class="mobile-menu-button lg:hidden p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200">
                <i class="fas fa-bars text-gray-600"></i>
            </button>
            
            <h1 class="text-xl font-semibold text-gray-800">Reports & Analytics</h1>
        </div>
        
        <div class="flex items-center gap-4">
            <!-- System Status -->
            <div class="hidden md:flex items-center gap-2 px-3 py-1 system-status rounded-full">
                <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                <span class="text-xs font-medium">System Online</span>
            </div>

            <!-- Notifications -->
            <div class="relative">
                <button onclick="toggleNotif()" id="notifBell" class="p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200 relative">
                    <i class="fas fa-bell text-gray-600"></i>
                    <span id="notifCount" class="notification-badge absolute -top-1 -right-1 w-5 h-5 flex items-center justify-center text-xs text-white rounded-full hidden">0</span>
                </button>
                <div id="notifMenu" class="dropdown-menu absolute right-0 mt-2 w-80 rounded-lg py-2 hidden z-50">
                    <h3 class="px-4 py-2 text-gray-700 font-semibold border-b">System Status</h3>
                    <div id="notifList" class="max-h-64 overflow-y-auto px-4 py-2 text-sm text-gray-800 space-y-2">
                        <p class="text-gray-500 italic text-center">Loading notifications...</p>
                    </div>
                    <hr class="my-1">
                    <a href="/notification" class="block px-4 py-2 text-blue-600 hover:bg-blue-50 text-center text-sm">View Full Report</a>
                </div>
            </div>

            <!-- User Menu -->
            <div class="relative">
                <button class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-colors duration-200" onclick="toggleDropdown()">
                    <img src="/static/images/OIP.jpg" alt="User Avatar" class="user-avatar w-8 h-8 rounded-full">
                    <div class="hidden md:block text-left">
                        <p class="text-sm font-medium text-gray-800">Admin</p>
                        <p class="text-xs text-gray-500">Administrator</p>
                    </div>
                    <i class="fas fa-chevron-down text-xs text-gray-400 hidden md:block"></i>
                </button>
                
                <div id="dropdownMenu" class="dropdown-menu absolute right-0 mt-2 w-56 rounded-lg py-2 hidden z-50">
                    <div class="px-4 py-2 border-b">
                        <p class="text-sm font-medium text-gray-800">My Account</p>
                    </div>
                    <a href="/profile" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-user text-gray-400"></i>
                        <span>Profile Settings</span>
                    </a>
                    <a href="/manage_users" class="flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                        <i class="fas fa-users text-gray-400"></i>
                        <span>Manage Users</span>
                    </a>
                    <hr class="my-1">
                    <button onclick="logout()" class="flex items-center gap-3 px-4 py-2 text-red-600 hover:bg-red-50 transition-colors duration-200 w-full text-left">
                        <i class="fas fa-sign-out-alt text-red-400"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Overlay -->
    <div id="mobileOverlay" class="mobile-overlay fixed inset-0 z-40 hidden lg:hidden" onclick="closeMobileMenu()"></div>

    <!-- Main Content -->
    <main id="mainContent" class="main-content-transition pt-20 pb-8 px-6 lg:ml-72">
        <div class="space-y-6">
            <!-- Header -->
            <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white animate-fade-in">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-3xl font-bold mb-2">ðŸ“Š Reports & Analytics</h2>
                        <p class="text-purple-100">Comprehensive reporting and data analysis for your aquaculture system</p>
                    </div>
                    <div class="hidden md:block">
                        <div class="bg-white/10 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold" id="totalRecords">0</div>
                            <div class="text-sm text-purple-100">Total Records</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Filter -->
            <div class="chart-container rounded-2xl p-6 animate-fade-in">
                <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between mb-4 gap-4">
                    <div class="flex items-center">
                        <i class="fas fa-calendar text-blue-600 mr-2"></i>
                        <h3 class="text-lg font-semibold text-gray-800">Date Range Filter</h3>
                        <span class="ml-4 text-sm text-gray-600" id="currentDateRange">Last 7 Days</span>
                    </div>
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">From:</label>
                            <input type="date" id="start_date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-medium text-gray-700">To:</label>
                            <input type="date" id="end_date" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="fetchReport()" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200">
                                <i class="fas fa-search mr-2"></i>Filter
                            </button>
                            <!-- Enhanced Export Button with Dropdown -->
                            <div class="relative">
                                <button onclick="toggleExportDropdown()" class="export-button text-white px-4 py-2 rounded-lg hover:shadow-lg transition-all duration-200 flex items-center gap-2">
                                    <i class="fas fa-download"></i>
                                    <span>Export</span>
                                    <i class="fas fa-chevron-down text-xs"></i>
                                </button>
                                <div id="exportDropdown" class="export-dropdown absolute right-0 mt-2 w-48 rounded-lg py-2 hidden z-50">
                                    <button onclick="downloadExcel()" class="export-option flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200 w-full text-left">
                                        <i class="fas fa-file-excel text-green-600"></i>
                                        <span>Export to Excel</span>
                                    </button>
                                    <button onclick="downloadCSV()" class="export-option flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200 w-full text-left">
                                        <i class="fas fa-file-csv text-blue-600"></i>
                                        <span>Export to CSV</span>
                                    </button>
                                    <button onclick="downloadPDF()" class="export-option flex items-center gap-3 px-4 py-2 text-gray-700 hover:bg-gray-50 transition-colors duration-200 w-full text-left">
                                        <i class="fas fa-file-pdf text-red-600"></i>
                                        <span>Export to PDF</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 animate-fade-in">
                <div class="analytics-card rounded-xl p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Avg Temperature</p>
                            <p class="text-2xl font-bold text-gray-800" id="avgTemp">--Â°C</p>
                            <div class="flex items-center mt-1">
                                <i id="tempTrend" class="fas fa-minus text-gray-400 mr-1"></i>
                                <span id="tempTrendText" class="text-xs text-gray-500">No trend data</span>
                            </div>
                        </div>
                        <div class="bg-red-100 p-3 rounded-full">
                            <i class="fas fa-thermometer-half text-red-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card rounded-xl p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Avg pH Level</p>
                            <p class="text-2xl font-bold text-gray-800" id="avgPH">--</p>
                            <div class="flex items-center mt-1">
                                <i id="phTrend" class="fas fa-minus text-gray-400 mr-1"></i>
                                <span id="phTrendText" class="text-xs text-gray-500">No trend data</span>
                            </div>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-full">
                            <i class="fas fa-vial text-blue-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card rounded-xl p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Avg TDS</p>
                            <p class="text-2xl font-bold text-gray-800" id="avgTDS">-- ppm</p>
                            <div class="flex items-center mt-1">
                                <i id="tdsTrend" class="fas fa-minus text-gray-400 mr-1"></i>
                                <span id="tdsTrendText" class="text-xs text-gray-500">No trend data</span>
                            </div>
                        </div>
                        <div class="bg-green-100 p-3 rounded-full">
                            <i class="fas fa-tint text-green-600"></i>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-card rounded-xl p-6 border-l-4 border-purple-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 font-medium">Avg Turbidity</p>
                            <p class="text-2xl font-bold text-gray-800" id="avgTurbidity">-- NTU</p>
                            <div class="flex items-center mt-1">
                                <i id="turbidityTrend" class="fas fa-minus text-gray-400 mr-1"></i>
                                <span id="turbidityTrendText" class="text-xs text-gray-500">No trend data</span>
                            </div>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-full">
                            <i class="fas fa-eye text-purple-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 animate-fade-in">
                <div class="chart-container rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Temperature & pH Trends</h3>
                    <div class="relative h-72">
                        <canvas id="tempPhChart"></canvas>
                    </div>
                </div>
                <div class="chart-container rounded-xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">TDS & Turbidity Levels</h3>
                    <div class="relative h-72">
                        <canvas id="tdsTurbidityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Quality Analysis -->
            <div class="chart-container rounded-xl p-6 animate-fade-in">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Data Quality Analysis</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-green-600 font-medium">Optimal Readings</p>
                                <p class="text-2xl font-bold text-green-800" id="optimalCount">0</p>
                                <p class="text-xs text-green-600" id="optimalPercentage">0%</p>
                            </div>
                            <i class="fas fa-check-circle text-3xl text-green-500"></i>
                        </div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 border border-yellow-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-yellow-600 font-medium">Warning Readings</p>
                                <p class="text-2xl font-bold text-yellow-800" id="warningCount">0</p>
                                <p class="text-xs text-yellow-600" id="warningPercentage">0%</p>
                            </div>
                            <i class="fas fa-exclamation-triangle text-3xl text-yellow-500"></i>
                        </div>
                    </div>
                    <div class="bg-red-50 rounded-lg p-4 border border-red-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-red-600 font-medium">Critical Readings</p>
                                <p class="text-2xl font-bold text-red-800" id="criticalCount">0</p>
                                <p class="text-xs text-red-600" id="criticalPercentage">0%</p>
                            </div>
                            <i class="fas fa-times-circle text-3xl text-red-500"></i>
                        </div>
                    </div>
                </div>
                <div class="relative h-64">
                    <canvas id="qualityChart"></canvas>
                </div>
            </div>

            <!-- Data Table -->
            <div class="chart-container rounded-xl overflow-hidden animate-fade-in">
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
                    <h4 class="text-lg font-semibold text-gray-800">Sensor Readings</h4>
                    <div id="loadingIndicator" class="hidden flex items-center">
                        <div class="loading-spinner mr-2"></div>
                        <span class="text-sm text-gray-600">Loading...</span>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temperature (Â°C)</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">pH Level</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TDS (ppm)</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Turbidity (NTU)</th>
                                <th class="px-6 py-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody id="reportTable" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global variables
        let charts = {};
        let lastNotifCount = 0;
        let currentData = [];
        let previousData = [];

        // Initialize page
        function initPage() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 7);
            
            document.getElementById('start_date').valueAsDate = startDate;
            document.getElementById('end_date').valueAsDate = endDate;
            
            fetchReport();
            setupMobileMenu();
        }

        // Setup mobile menu
        function setupMobileMenu() {
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            mobileMenuButton.addEventListener('click', () => {
                sidebar.classList.add('sidebar-open');
                mobileOverlay.classList.remove('hidden');
            });

            function closeMobileMenu() {
                sidebar.classList.remove('sidebar-open');
                mobileOverlay.classList.add('hidden');
            }

            mobileOverlay.addEventListener('click', closeMobileMenu);

            // Close mobile menu when clicking on navigation links
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        closeMobileMenu();
                    }
                });
            });
        }

        // Toggle export dropdown
        function toggleExportDropdown() {
            const dropdown = document.getElementById('exportDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Fetch report data - improved version based on your reference function
        function fetchReport() {
            const loadingIndicator = document.getElementById("loadingIndicator");
            const reportTable = document.getElementById("reportTable");
            
            loadingIndicator.classList.remove('hidden');
            
            let startDate = document.getElementById("start_date").value;
            let endDate = document.getElementById("end_date").value;

            let url = "/fetch_reports";
            let params = [];
            
            if (startDate) params.push(`start=${startDate}`);
            if (endDate) params.push(`end=${endDate}`);
            
            if (params.length > 0) {
                url += "?" + params.join("&");
            }

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    loadingIndicator.classList.add('hidden');
                    reportTable.innerHTML = "";

                    if (!data || data.length === 0) {
                        reportTable.innerHTML = `
                            <tr>
                                <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center">
                                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                                        <p>No data available for the selected date range</p>
                                    </div>
                                </td>
                            </tr>`;
                        resetAnalytics();
                        return;
                    }

                    // Store previous data for trend analysis
                    previousData = [...currentData];
                    currentData = data;

                    // Update analytics
                    calculateAverages(data);
                    calculateTrends(data, previousData);
                    calculateDataQuality(data);
                    updateCharts(data);

                    // Populate table
                    data.forEach((row, index) => {
                        const status = getDataStatus(row);
                        let tableRow = `
                            <tr class="table-row hover:bg-blue-50 transition-colors duration-200">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <i class="fas fa-clock text-gray-400 mr-2"></i>
                                        ${row.timestamp || 'N/A'}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-red-400 mr-2"></div>
                                        ${parseFloat(row.temperature).toFixed(1)}Â°C
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-green-400 mr-2"></div>
                                        ${parseFloat(row.ph_level).toFixed(1)}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-yellow-400 mr-2"></div>
                                        ${parseFloat(row.tds_value).toFixed(0)} ppm
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <div class="flex items-center">
                                        <div class="w-2 h-2 rounded-full bg-purple-400 mr-2"></div>
                                        ${parseFloat(row.turbidity).toFixed(1)} NTU
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <span class="status-badge ${status.class}">
                                        ${status.text}
                                    </span>
                                </td>
                            </tr>`;
                        reportTable.innerHTML += tableRow;
                    });
                })
                .catch(error => {
                    loadingIndicator.classList.add('hidden');
                    console.error("Error fetching report:", error);
                    reportTable.innerHTML = `
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-red-500">
                                <div class="flex flex-col items-center">
                                    <i class="fas fa-exclamation-triangle text-4xl text-red-300 mb-3"></i>
                                    <p>Error loading reports. Please try again.</p>
                                    <button onclick="fetchReport()" class="mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                                        Retry
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    resetAnalytics();
                });
        }

        // Enhanced Excel Export Function
        function downloadExcel() {
            if (!currentData || currentData.length === 0) {
                alert("No data available to export!");
                return;
            }

            try {
                // Create workbook and worksheet
                const wb = XLSX.utils.book_new();
                
                // Prepare data for Excel
                const excelData = currentData.map((row, index) => {
                    const status = getDataStatus(row);
                    return {
                        'S/N': index + 1,
                        'Timestamp': row.timestamp || 'N/A',
                        'Temperature (Â°C)': parseFloat(row.temperature).toFixed(1),
                        'pH Level': parseFloat(row.ph_level).toFixed(1),
                        'TDS (ppm)': parseFloat(row.tds_value).toFixed(0),
                        'Turbidity (NTU)': parseFloat(row.turbidity).toFixed(1),
                        'Status': status.text
                    };
                });

                // Create main data worksheet
                const ws1 = XLSX.utils.json_to_sheet(excelData);
                
                // Set column widths
                ws1['!cols'] = [
                    { wch: 8 },   // S/N
                    { wch: 20 },  // Timestamp
                    { wch: 15 },  // Temperature
                    { wch: 12 },  // pH Level
                    { wch: 12 },  // TDS
                    { wch: 15 },  // Turbidity
                    { wch: 12 }   // Status
                ];

                // Add main data sheet
                XLSX.utils.book_append_sheet(wb, ws1, "Sensor Readings");

                // Create summary sheet
                const summaryData = [
                    { 'Metric': 'Total Records', 'Value': currentData.length },
                    { 'Metric': 'Average Temperature (Â°C)', 'Value': document.getElementById('avgTemp').textContent },
                    { 'Metric': 'Average pH Level', 'Value': document.getElementById('avgPH').textContent },
                    { 'Metric': 'Average TDS (ppm)', 'Value': document.getElementById('avgTDS').textContent },
                    { 'Metric': 'Average Turbidity (NTU)', 'Value': document.getElementById('avgTurbidity').textContent },
                    { 'Metric': '', 'Value': '' }, // Empty row
                    { 'Metric': 'Data Quality Analysis', 'Value': '' },
                    { 'Metric': 'Optimal Readings', 'Value': document.getElementById('optimalCount').textContent + ' (' + document.getElementById('optimalPercentage').textContent + ')' },
                    { 'Metric': 'Warning Readings', 'Value': document.getElementById('warningCount').textContent + ' (' + document.getElementById('warningPercentage').textContent + ')' },
                    { 'Metric': 'Critical Readings', 'Value': document.getElementById('criticalCount').textContent + ' (' + document.getElementById('criticalPercentage').textContent + ')' }
                ];

                const ws2 = XLSX.utils.json_to_sheet(summaryData);
                ws2['!cols'] = [{ wch: 25 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, ws2, "Summary");

                // Create quality analysis sheet
                let optimal = 0, warning = 0, critical = 0;
                const qualityData = currentData.map((row, index) => {
                    const status = getDataStatus(row);
                    if (status.text === 'Optimal') optimal++;
                    else if (status.text === 'Warning') warning++;
                    else critical++;
                    
                    return {
                        'S/N': index + 1,
                        'Timestamp': row.timestamp || 'N/A',
                        'Temperature Status': getTempStatus(parseFloat(row.temperature)),
                        'pH Status': getPhStatus(parseFloat(row.ph_level)),
                        'TDS Status': getTdsStatus(parseFloat(row.tds_value)),
                        'Turbidity Status': getTurbidityStatus(parseFloat(row.turbidity)),
                        'Overall Status': status.text
                    };
                });

                const ws3 = XLSX.utils.json_to_sheet(qualityData);
                ws3['!cols'] = [
                    { wch: 8 },   // S/N
                    { wch: 20 },  // Timestamp
                    { wch: 15 },  // Temperature Status
                    { wch: 12 },  // pH Status
                    { wch: 12 },  // TDS Status
                    { wch: 15 },  // Turbidity Status
                    { wch: 15 }   // Overall Status
                ];
                XLSX.utils.book_append_sheet(wb, ws3, "Quality Analysis");

                // Generate filename with current date and time
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `V-CRAB_Report_${dateStr}_${timeStr}.xlsx`;

                // Save the file
                XLSX.writeFile(wb, filename);

                // Show success message
                showNotification('Excel file downloaded successfully!', 'success');
                
                // Hide export dropdown
                document.getElementById('exportDropdown').classList.add('hidden');

            } catch (error) {
                console.error('Error creating Excel file:', error);
                showNotification('Error creating Excel file. Please try again.', 'error');
            }
        }

        // Helper functions for status determination
        function getTempStatus(temp) {
            if (temp < 25 || temp > 35) return 'Critical';
            if (temp < 24 || temp > 30) return 'Warning';
            return 'Optimal';
        }

        function getPhStatus(ph) {
            if (ph < 7.5 || ph > 9.0) return 'Critical';
            if (ph < 6.5 || ph > 8.5) return 'Warning';
            return 'Optimal';
        }

        function getTdsStatus(tds) {
            if (tds > 1000) return 'Critical';
            if (tds > 40) return 'Warning';
            return 'Optimal';
        }

        function getTurbidityStatus(turbidity) {
            if (turbidity > 100) return 'Critical';
            if (turbidity > 50) return 'Warning';
            return 'Optimal';
        }

        // Show notification function
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-20 right-6 z-50 p-4 rounded-lg shadow-lg transition-all duration-300 transform translate-x-full`;
            
            if (type === 'success') {
                notification.className += ' bg-green-100 border border-green-400 text-green-700';
                notification.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
            } else if (type === 'error') {
                notification.className += ' bg-red-100 border border-red-400 text-red-700';
                notification.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
            } else {
                notification.className += ' bg-blue-100 border border-blue-400 text-blue-700';
                notification.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
            }

            document.body.appendChild(notification);

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // Enhanced PDF Export Function
        function downloadPDF() {
            if (!currentData || currentData.length === 0) {
                alert("No data available to export!");
                return;
            }

            // Create a new window for PDF generation
            const printWindow = window.open('', '_blank');
            
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>V-CRAB System Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .summary { margin-bottom: 30px; }
                        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
                        .summary-card { border: 1px solid #ddd; padding: 15px; border-radius: 8px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .status-optimal { background-color: #dcfce7; color: #166534; }
                        .status-warning { background-color: #fef3c7; color: #92400e; }
                        .status-critical { background-color: #fee2e2; color: #991b1b; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>ðŸ¦€ V-CRAB System Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                        <p>Date Range: ${document.getElementById('start_date').value} to ${document.getElementById('end_date').value}</p>
                    </div>
                    
                    <div class="summary">
                        <h2>Summary Statistics</h2>
                        <div class="summary-grid">
                            <div class="summary-card">
                                <h3>Average Temperature</h3>
                                <p>${document.getElementById('avgTemp').textContent}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Average pH Level</h3>
                                <p>${document.getElementById('avgPH').textContent}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Average TDS</h3>
                                <p>${document.getElementById('avgTDS').textContent}</p>
                            </div>
                            <div class="summary-card">
                                <h3>Average Turbidity</h3>
                                <p>${document.getElementById('avgTurbidity').textContent}</p>
                            </div>
                        </div>
                        
                        <h3>Data Quality Analysis</h3>
                        <p>Optimal Readings: ${document.getElementById('optimalCount').textContent} (${document.getElementById('optimalPercentage').textContent})</p>
                        <p>Warning Readings: ${document.getElementById('warningCount').textContent} (${document.getElementById('warningPercentage').textContent})</p>
                        <p>Critical Readings: ${document.getElementById('criticalCount').textContent} (${document.getElementById('criticalPercentage').textContent})</p>
                    </div>
                    
                    <h2>Detailed Sensor Readings</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Temperature (Â°C)</th>
                                <th>pH Level</th>
                                <th>TDS (ppm)</th>
                                <th>Turbidity (NTU)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${currentData.map(row => {
                                const status = getDataStatus(row);
                                return `
                                    <tr>
                                        <td>${row.timestamp || 'N/A'}</td>
                                        <td>${parseFloat(row.temperature).toFixed(1)}</td>
                                        <td>${parseFloat(row.ph_level).toFixed(1)}</td>
                                        <td>${parseFloat(row.tds_value).toFixed(0)}</td>
                                        <td>${parseFloat(row.turbidity).toFixed(1)}</td>
                                        <td class="status-${status.text.toLowerCase()}">${status.text}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;

            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                printWindow.print();
                printWindow.close();
            };

            // Hide export dropdown
            document.getElementById('exportDropdown').classList.add('hidden');
            showNotification('PDF export initiated!', 'success');
        }

        // Calculate averages and update UI
        function calculateAverages(data) {
            if (!data || data.length === 0) {
                document.getElementById('avgTemp').textContent = '--Â°C';
                document.getElementById('avgPH').textContent = '--';
                document.getElementById('avgTDS').textContent = '-- ppm';
                document.getElementById('avgTurbidity').textContent = '-- NTU';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            const totals = data.reduce((acc, row) => {
                acc.temp += parseFloat(row.temperature) || 0;
                acc.ph += parseFloat(row.ph_level) || 0;
                acc.tds += parseFloat(row.tds_value) || 0;
                acc.turbidity += parseFloat(row.turbidity) || 0;
                return acc;
            }, { temp: 0, ph: 0, tds: 0, turbidity: 0 });
            
            const count = data.length;
            document.getElementById('avgTemp').textContent = (totals.temp / count).toFixed(1) + 'Â°C';
            document.getElementById('avgPH').textContent = (totals.ph / count).toFixed(1);
            document.getElementById('avgTDS').textContent = (totals.tds / count).toFixed(0) + ' ppm';
            document.getElementById('avgTurbidity').textContent = (totals.turbidity / count).toFixed(1) + ' NTU';
            document.getElementById('totalRecords').textContent = count.toLocaleString();
        }

        // Calculate trends
        function calculateTrends(currentData, previousData) {
            if (!previousData || previousData.length === 0) {
                resetTrends();
                return;
            }

            const currentAvg = calculateDataAverages(currentData);
            const previousAvg = calculateDataAverages(previousData);

            updateTrendIndicator('temp', currentAvg.temp, previousAvg.temp, 'Â°C');
            updateTrendIndicator('ph', currentAvg.ph, previousAvg.ph, '');
            updateTrendIndicator('tds', currentAvg.tds, previousAvg.tds, ' ppm');
            updateTrendIndicator('turbidity', currentAvg.turbidity, previousAvg.turbidity, ' NTU');
        }

        // Helper function to calculate averages
        function calculateDataAverages(data) {
            if (!data || data.length === 0) return { temp: 0, ph: 0, tds: 0, turbidity: 0 };
            
            const totals = data.reduce((acc, row) => {
                acc.temp += parseFloat(row.temperature) || 0;
                acc.ph += parseFloat(row.ph_level) || 0;
                acc.tds += parseFloat(row.tds_value) || 0;
                acc.turbidity += parseFloat(row.turbidity) || 0;
                return acc;
            }, { temp: 0, ph: 0, tds: 0, turbidity: 0 });

            const count = data.length;
            return {
                temp: totals.temp / count,
                ph: totals.ph / count,
                tds: totals.tds / count,
                turbidity: totals.turbidity / count
            };
        }

        // Update trend indicator
        function updateTrendIndicator(parameter, current, previous, unit) {
            const trendIcon = document.getElementById(`${parameter}Trend`);
            const trendText = document.getElementById(`${parameter}TrendText`);
            
            const difference = current - previous;
            const percentChange = previous !== 0 ? ((difference / previous) * 100) : 0;
            
            if (Math.abs(percentChange) < 1) {
                trendIcon.className = 'fas fa-minus trend-stable mr-1';
                trendText.textContent = 'Stable';
                trendText.className = 'text-xs trend-stable';
            } else if (difference > 0) {
                trendIcon.className = 'fas fa-arrow-up trend-up mr-1';
                trendText.textContent = `+${Math.abs(percentChange).toFixed(1)}%`;
                trendText.className = 'text-xs trend-up';
            } else {
                trendIcon.className = 'fas fa-arrow-down trend-down mr-1';
                trendText.textContent = `-${Math.abs(percentChange).toFixed(1)}%`;
                trendText.className = 'text-xs trend-down';
            }
        }

        // Reset trends
        function resetTrends() {
            ['temp', 'ph', 'tds', 'turbidity'].forEach(param => {
                const trendIcon = document.getElementById(`${param}Trend`);
                const trendText = document.getElementById(`${param}TrendText`);
                trendIcon.className = 'fas fa-minus text-gray-400 mr-1';
                trendText.textContent = 'No trend data';
                trendText.className = 'text-xs text-gray-500';
            });
        }

        // Calculate data quality
        function calculateDataQuality(data) {
            if (!data || data.length === 0) {
                document.getElementById('optimalCount').textContent = '0';
                document.getElementById('warningCount').textContent = '0';
                document.getElementById('criticalCount').textContent = '0';
                document.getElementById('optimalPercentage').textContent = '0%';
                document.getElementById('warningPercentage').textContent = '0%';
                document.getElementById('criticalPercentage').textContent = '0%';
                return;
            }

            let optimal = 0, warning = 0, critical = 0;

            data.forEach(row => {
                const status = getDataStatus(row);
                if (status.text === 'Optimal') optimal++;
                else if (status.text === 'Warning') warning++;
                else critical++;
            });

            const total = data.length;
            document.getElementById('optimalCount').textContent = optimal.toLocaleString();
            document.getElementById('warningCount').textContent = warning.toLocaleString();
            document.getElementById('criticalCount').textContent = critical.toLocaleString();
            document.getElementById('optimalPercentage').textContent = ((optimal / total) * 100).toFixed(1) + '%';
            document.getElementById('warningPercentage').textContent = ((warning / total) * 100).toFixed(1) + '%';
            document.getElementById('criticalPercentage').textContent = ((critical / total) * 100).toFixed(1) + '%';

            // Update quality chart
            updateQualityChart(optimal, warning, critical);
        }

        // Get data status
        function getDataStatus(row) {
            const temp = parseFloat(row.temperature) || 0;
            const ph = parseFloat(row.ph_level) || 0;
            const tds = parseFloat(row.tds_value) || 0;
            const turbidity = parseFloat(row.turbidity) || 0;

            // Critical thresholds
            if (temp < 20 || temp > 35 || ph < 6.0 || ph > 9.0 || tds > 800 || turbidity > 10) {
                return { text: 'Critical', class: 'status-critical' };
            }
            
            // Warning thresholds
            if (temp < 24 || temp > 30 || ph < 6.5 || ph > 8.5 || tds > 600 || turbidity > 5) {
                return { text: 'Warning', class: 'status-warning' };
            }
            
            return { text: 'Optimal', class: 'status-optimal' };
        }

        // Update charts
        function updateCharts(data) {
            if (!data || data.length === 0) return;

            // Sort data by timestamp
            const sortedData = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const labels = sortedData.map(d => new Date(d.timestamp).toLocaleTimeString());

            // Temperature & pH Chart
            updateTempPhChart(labels, sortedData);
            
            // TDS & Turbidity Chart
            updateTdsTurbidityChart(labels, sortedData);
        }

        // Update Temperature & pH Chart
        function updateTempPhChart(labels, data) {
            const ctx = document.getElementById('tempPhChart').getContext('2d');
            
            if (charts.tempPh) {
                charts.tempPh.destroy();
            }

            charts.tempPh = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperature (Â°C)',
                        data: data.map(d => parseFloat(d.temperature) || 0),
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: false
                    }, {
                        label: 'pH Level',
                        data: data.map(d => parseFloat(d.ph_level) || 0),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Update TDS & Turbidity Chart
        function updateTdsTurbidityChart(labels, data) {
            const ctx = document.getElementById('tdsTurbidityChart').getContext('2d');
            
            if (charts.tdsTurbidity) {
                charts.tdsTurbidity.destroy();
            }

            charts.tdsTurbidity = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'TDS (ppm)',
                        data: data.map(d => parseFloat(d.tds_value) || 0),
                        backgroundColor: 'rgba(16, 185, 129, 0.6)',
                        borderColor: '#10b981',
                        borderWidth: 1
                    }, {
                        label: 'Turbidity (NTU)',
                        data: data.map(d => parseFloat(d.turbidity) || 0),
                        backgroundColor: 'rgba(139, 92, 246, 0.6)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Update quality chart
        function updateQualityChart(optimal, warning, critical) {
            const ctx = document.getElementById('qualityChart').getContext('2d');
            
            if (charts.quality) {
                charts.quality.destroy();
            }

            charts.quality = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Optimal', 'Warning', 'Critical'],
                    datasets: [{
                        data: [optimal, warning, critical],
                        backgroundColor: [
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        }
                    }
                }
            });
        }

        // Reset analytics
        function resetAnalytics() {
            document.getElementById('avgTemp').textContent = '--Â°C';
            document.getElementById('avgPH').textContent = '--';
            document.getElementById('avgTDS').textContent = '-- ppm';
            document.getElementById('avgTurbidity').textContent = '-- NTU';
            document.getElementById('totalRecords').textContent = '0';
            
            document.getElementById('optimalCount').textContent = '0';
            document.getElementById('warningCount').textContent = '0';
            document.getElementById('criticalCount').textContent = '0';
            document.getElementById('optimalPercentage').textContent = '0%';
            document.getElementById('warningPercentage').textContent = '0%';
            document.getElementById('criticalPercentage').textContent = '0%';
            
            resetTrends();
            
            // Clear charts
            Object.values(charts).forEach(chart => {
                if (chart) chart.destroy();
            });
            charts = {};
        }

        // Download CSV (kept as backup option)
        function downloadCSV() {
            if (!currentData || currentData.length === 0) {
                alert("No data available to export!");
                return;
            }

            try {
                // Create CSV content
                const headers = ['S/N', 'Timestamp', 'Temperature (Â°C)', 'pH Level', 'TDS (ppm)', 'Turbidity (NTU)', 'Status'];
                let csvContent = headers.join(',') + '\n';

                currentData.forEach((row, index) => {
                    const status = getDataStatus(row);
                    const csvRow = [
                        index + 1,
                        `"${row.timestamp || 'N/A'}"`,
                        parseFloat(row.temperature).toFixed(1),
                        parseFloat(row.ph_level).toFixed(1),
                        parseFloat(row.tds_value).toFixed(0),
                        parseFloat(row.turbidity).toFixed(1),
                        `"${status.text}"`
                    ];
                    csvContent += csvRow.join(',') + '\n';
                });

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `V-CRAB_Report_${dateStr}_${timeStr}.csv`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('CSV file downloaded successfully!', 'success');
                document.getElementById('exportDropdown').classList.add('hidden');

            } catch (error) {
                console.error('Error creating CSV file:', error);
                showNotification('Error creating CSV file. Please try again.', 'error');
            }
        }

        // Notification functions
        function fetchNotifications(realTime = false) {
            fetch('/api/notifications')
                .then(response => response.json())
                .then(data => {
                    const notifList = document.getElementById('notifList');
                    const notifCount = document.getElementById('notifCount');

                    notifList.innerHTML = '';
                    notifCount.innerText = data.length;

                    if (realTime && data.length > lastNotifCount) {
                        playNotifSound();
                        animateNotifBell();
                    }

                    lastNotifCount = data.length;

                    if (data.length === 0) {
                        notifList.innerHTML = '<p class="text-gray-500 italic text-center">No notifications available.</p>';
                        return;
                    }

                    data.slice(0, 5).forEach(item => {
                        const statusColor = item.status.toLowerCase() === 'safe' ? 'text-green-600' : 'text-red-600';
                        const notifItem = `
                            <div class="border-b pb-1">
                                <p>ðŸ”” <strong>${item.parameter}</strong>: 
                                    <span class="${statusColor} font-medium">${item.value} - ${item.status}</span>
                                </p>
                                <p class="text-xs text-gray-500">${new Date(item.timestamp).toLocaleString()}</p>
                            </div>
                        `;
                        notifList.innerHTML += notifItem;
                    });
                })
                .catch(err => {
                    console.error("Notification error:", err);
                });
        }

        function toggleNotif() {
            const notifMenu = document.getElementById("notifMenu");
            notifMenu.classList.toggle("hidden");

            if (!notifMenu.classList.contains("hidden")) {
                fetchNotifications();
            }
        }

        function toggleDropdown() {
            const dropdownMenu = document.getElementById("dropdownMenu");
            dropdownMenu.classList.toggle("hidden");
        }

        function playNotifSound() {
            // You can add notification sound here
        }

        function animateNotifBell() {
            const bell = document.querySelector("#notifBell");
            bell.classList.add("ping-animation");
            setTimeout(() => bell.classList.remove("ping-animation"), 800);
        }

        function logout() {
            window.location.href = "/logout";
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initPage();
            fetchNotifications();
            
            // Set up periodic notification updates
            setInterval(() => {
                fetchNotifications(true);
            }, 10000);
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const notifMenu = document.getElementById('notifMenu');
            const dropdownMenu = document.getElementById('dropdownMenu');
            const exportDropdown = document.getElementById('exportDropdown');
            
            if (!event.target.closest('#notifBell') && !notifMenu.contains(event.target)) {
                notifMenu.classList.add('hidden');
            }
            
            if (!event.target.closest('[onclick="toggleDropdown()"]') && !dropdownMenu.contains(event.target)) {
                dropdownMenu.classList.add('hidden');
            }

            if (!event.target.closest('[onclick="toggleExportDropdown()"]') && !exportDropdown.contains(event.target)) {
                exportDropdown.classList.add('hidden');
            }
        });
    </script>

    <audio id="notifSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1150-pristine.mp3" preload="auto"></audio>
</body>
</html>
